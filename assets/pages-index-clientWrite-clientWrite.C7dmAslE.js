var le=Object.defineProperty,se=Object.defineProperties;var ne=Object.getOwnPropertyDescriptors;var O=Object.getOwnPropertySymbols;var ue=Object.prototype.hasOwnProperty,ce=Object.prototype.propertyIsEnumerable;var U=(f,o,r)=>o in f?le(f,o,{enumerable:!0,configurable:!0,writable:!0,value:r}):f[o]=r,H=(f,o)=>{for(var r in o||(o={}))ue.call(o,r)&&U(f,r,o[r]);if(O)for(var r of O(o))ce.call(o,r)&&U(f,r,o[r]);return f},A=(f,o)=>se(f,ne(o));var I=(f,o,r)=>new Promise((u,k)=>{var _=i=>{try{c(r.next(i))}catch(y){k(y)}},p=i=>{try{c(r.throw(i))}catch(y){k(y)}},c=i=>i.done?u(i.value):Promise.resolve(i.value).then(_,p);c((r=r.apply(f,o)).next())});import{d as de,r as g,x as re,c as ie,F as me,a as x,w as a,G as fe,E as F,b as R,e as M,H as _e,f as C,J as pe,_ as ve,o as b,g as t,i as ge,K as ye,l as e,M as he,y as D,k as d,j as P,z as we,t as h,N as be,B as ke,m as W,O as Te,P as q,p as xe}from"./index-PW8lkL3M.js";import{T as Ne}from"./TopHeader.CoiZ0Ai5.js";import{_ as Me,a as Ce}from"./wd-textarea.BSHhK-Vk.js";import{u as Le,a as Ve,b as $e}from"./jdwl.DcTopnLo.js";import"./vue-query.DoLthAjK.js";const Be=de({__name:"clientWrite",setup(f){const o=g({customerName:"",customerPhone:sessionStorage.getItem("phone"),needType:"",address:""}),r=g(sessionStorage.getItem("phone")),u=g({customerName:"",customerPhone:"",needType:"",address:""}),k=g(!0),_=g({latitude:34.79011,longitude:113.543474}),p=g({latitude:0,longitude:0,range:500}),c=g(!1),i=g(""),y=g(!1),L=g(!1),z=g([]);re(()=>{J()});function G(){k.value=!0,o.value={customerName:"",customerPhone:sessionStorage.getItem("phone"),needType:"",address:""}}function J(){return I(this,null,function*(){const l=yield Le({params:{dictType:"jdwl_need_type"}});l.code==200&&(z.value=l.data)})}const S=ie(()=>{let l=0;return o.value.customerName&&!u.value.customerName&&(l+=33),o.value.needType&&!u.value.needType&&(l+=33),o.value.address&&!u.value.address&&(l+=34),Math.min(100,l)});function N(){y.value=!0,i.value="正在获取位置...",fe({type:"gcj02",geocode:!0,success:l=>{_.value={latitude:l.latitude,longitude:l.longitude},K(l.latitude,l.longitude),y.value=!1},fail:l=>{y.value=!1,i.value="获取位置失败，请检查定位权限",F({title:"定位失败",content:"无法获取您的位置信息，请确保已开启定位权限并重试。",showCancel:!1,confirmText:"重试",success:()=>{N()}})}})}function K(l,s){return I(this,null,function*(){try{const m=yield Ve({latitude:l,longitude:s});m.code===200&&m.data?(o.value.channelId=m.data.channelId,o.value.channelName=m.data.channelName,ee(m.data.latitude,m.data.longitude,m.data.range),c.value=!0,i.value=`已匹配营业厅：${m.data.channelName}（范围内）`):(c.value=!1,i.value="未在任何营业厅范围内，无法提交")}catch(m){c.value=!1,i.value="匹配营业厅失败，请重试"}})}function Q(l,s,m,n){const v=(m-l)*Math.PI/180,V=(n-s)*Math.PI/180,$=Math.sin(v/2)*Math.sin(v/2)+Math.cos(l*Math.PI/180)*Math.cos(m*Math.PI/180)*Math.sin(V/2)*Math.sin(V/2);return 6371e3*(2*Math.atan2(Math.sqrt($),Math.sqrt(1-$)))}function X(){if(p.value.latitude===0||p.value.longitude===0){i.value="请设置目标位置",c.value=!1;return}const l=Q(_.value.latitude,_.value.longitude,p.value.latitude,p.value.longitude);l<=p.value.range?(c.value=!0,i.value=`位置验证通过，距离目标点 ${Math.round(l)} 米`):(c.value=!1,i.value=`位置超出范围，距离目标点 ${Math.round(l)} 米，需要在 ${p.value.range} 米范围内`)}function T(l){switch(l){case"customerName":o.value.customerName.trim()?o.value.customerName.trim().length<2?u.value.customerName="姓名至少需要2个字符":u.value.customerName="":u.value.customerName="请填写姓名";break;case"needType":o.value.needType?u.value.needType="":u.value.needType="请选择需求类型";break;case"address":o.value.address.trim()?o.value.address.trim().length<5?u.value.address="地址至少需要5个字符":u.value.address="":u.value.address="请填写拆机地址";break}}function Z(){return T("customerName"),T("needType"),T("address"),Object.values(u.value).every(l=>l==="")}function Y(){return I(this,null,function*(){if(!Z()){W({title:"请检查表单信息",icon:"error"});return}if(!c.value){F({title:"位置验证失败",content:"请确保您在指定的工作范围内，然后重新定位后提交。",showCancel:!0,cancelText:"取消",confirmText:"重新定位",success:s=>{s.confirm&&N()}});return}Te({title:"提交中..."});try{const s=A(H({},o.value),{holdResult:"待处理",location:_.value,submitTime:new Date().toISOString()});yield $e({body:s}),q(),W({title:"提交成功",icon:"success",duration:2e3}),k.value=!1}catch(s){q(),F({title:"提交失败",content:"网络错误，请稍后重试",showCancel:!1})}})}function ee(l,s,m=500){p.value={latitude:l,longitude:s,range:m},_.value.latitude!==0&&X()}return me(()=>{N()}),(l,s)=>{const m=Ne,n=ge,j=M(C("wd-input"),_e),v=we,V=M(C("wd-picker"),Me),$=M(C("wd-textarea"),Ce),E=be,B=M(C("wd-button"),pe),ae=M(C("wd-icon"),ve),te=R("layout-default-uni"),oe=R("global-ku-root");return b(),x(oe,null,{default:a(()=>[t(te,null,{default:a(()=>[t(n,{class:"client-write-page min-h-screen bg-[#f5f5f5]"},{default:a(()=>[t(m,{phone:e(r)},null,8,["phone"]),e(k)?(b(),ye(he,{key:0},[t(n,{class:"content-container"},{default:a(()=>[t(n,{class:"process-detail-card"},{default:a(()=>[t(n,{class:"form-row"},{default:a(()=>[t(n,{class:"form-label"},{default:a(()=>[D("span",{style:{color:"red"}},"*"),d("姓名： ")]),_:1}),t(n,{class:"form-content"},{default:a(()=>[t(j,{modelValue:e(o).customerName,"onUpdate:modelValue":s[0]||(s[0]=w=>e(o).customerName=w),placeholder:"请输入姓名",clearable:"",onBlur:s[1]||(s[1]=w=>T("customerName"))},null,8,["modelValue"]),e(u).customerName?(b(),x(v,{key:0,class:"error-text"},{default:a(()=>[d(h(e(u).customerName),1)]),_:1})):P("",!0)]),_:1})]),_:1}),t(n,{class:"form-row"},{default:a(()=>[t(n,{class:"form-label"},{default:a(()=>[D("span",{style:{color:"red"}},"*"),d("需求类型： ")]),_:1}),t(n,{class:"form-content"},{default:a(()=>[t(V,{modelValue:e(o).needType,"onUpdate:modelValue":s[2]||(s[2]=w=>e(o).needType=w),columns:e(z),"label-key":"dictLabel","value-key":"dictValue",placeholder:"请选择需求类型",onChange:s[3]||(s[3]=w=>T("needType"))},null,8,["modelValue","columns"]),e(u).needType?(b(),x(v,{key:0,class:"error-text"},{default:a(()=>[d(h(e(u).needType),1)]),_:1})):P("",!0)]),_:1})]),_:1}),t(n,{class:"form-row"},{default:a(()=>[t(n,{class:"form-label"},{default:a(()=>[D("span",{style:{color:"red"}},"*"),d("拆机地址： ")]),_:1}),t(n,{class:"form-content"},{default:a(()=>[t($,{modelValue:e(o).address,"onUpdate:modelValue":s[4]||(s[4]=w=>e(o).address=w),placeholder:"请输入详细的拆机地址",rows:3,maxlength:200,"show-word-limit":"",onBlur:s[5]||(s[5]=w=>T("address"))},null,8,["modelValue"]),e(u).address?(b(),x(v,{key:0,class:"error-text"},{default:a(()=>[d(h(e(u).address),1)]),_:1})):P("",!0)]),_:1})]),_:1})]),_:1}),t(n,{class:"info-section"},{default:a(()=>[t(n,{class:"info-title"},{default:a(()=>[d(" 位置验证 ")]),_:1}),t(n,{class:"map-container"},{default:a(()=>[t(E,{latitude:e(_).latitude,longitude:e(_).longitude,circles:[{latitude:e(p).latitude,longitude:e(p).longitude,radius:e(p).range,color:e(c)?"#4CAF5020":"#ff475720",strokeWidth:2,fillColor:e(c)?"#4CAF5020":"#ff475720",strokeColor:e(c)?"#4CAF50":"#ff4757"}],scale:"15",enableZoom:"",enableSatellite:"",enablePoi:"",enableBuilding:"",class:"map",showLocation:"",onTap:N},null,8,["latitude","longitude","circles"])]),_:1}),t(n,{class:"location-info"},{default:a(()=>[t(n,{class:"info-row"},{default:a(()=>[t(v,{class:"info-label"},{default:a(()=>[d("位置状态：")]),_:1}),t(v,{class:ke(["info-value",{"text-green-500":e(c),"text-red-500":!e(c)}])},{default:a(()=>[d(h(e(y)?"定位中...":e(c)?"验证通过":"验证失败"),1)]),_:1},8,["class"])]),_:1}),t(n,{class:"info-row"},{default:a(()=>[t(v,{class:"info-label"},{default:a(()=>[d("详细信息：")]),_:1}),t(v,{class:"info-value"},{default:a(()=>[d(h(e(i)||"正在获取位置..."),1)]),_:1})]),_:1}),e(L)&&e(_).latitude?(b(),x(n,{key:0,class:"info-row"},{default:a(()=>[t(v,{class:"info-label"},{default:a(()=>[d("坐标信息：")]),_:1}),t(v,{class:"info-value"},{default:a(()=>[d(h(e(_).latitude.toFixed(6))+", "+h(e(_).longitude.toFixed(6)),1)]),_:1})]),_:1})):P("",!0)]),_:1}),t(n,{class:"location-actions"},{default:a(()=>[t(B,{size:"small",type:"primary",loading:e(y),onClick:N},{default:a(()=>[d(h(e(y)?"定位中...":"重新定位"),1)]),_:1},8,["loading"]),t(B,{size:"small",type:"text",onClick:s[6]||(s[6]=w=>L.value=!e(L))},{default:a(()=>[d(h(e(L)?"收起详情":"查看详情"),1)]),_:1})]),_:1})]),_:1})]),_:1}),t(n,{class:"bottom-button"},{default:a(()=>[t(B,{type:"success",block:"",size:"large",disabled:!e(c)||e(S)<100,onClick:Y},{default:a(()=>[d(h(e(S)<100?`完善表单信息 (${e(S)}%)`:e(c)?"提交":"等待位置验证"),1)]),_:1},8,["disabled"])]),_:1})],64)):(b(),x(n,{key:1,class:"submit-success flex items-center justify-center"},{default:a(()=>[t(ae,{name:"check-circle-filled",size:"80px",color:"#118EE9"}),t(n,{class:"submit-success-content"},{default:a(()=>[d(" 你的需求已记录，等待客服处理 ")]),_:1}),t(B,{block:"",size:"large","custom-class":"mt-20",onClick:G},{default:a(()=>[d(" 返回首页 ")]),_:1})]),_:1}))]),_:1})]),_:1})]),_:1})}}}),je=xe(Be,[["__scopeId","data-v-1c474255"]]);export{je as default};
